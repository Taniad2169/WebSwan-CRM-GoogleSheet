  }
            }, 100);
        } else {
            alert('Incorrect password. Please try again.');
        }
    });

    const submissionModal = document.getElementById('submissionModal');
    const okButton = submissionModal.querySelector(".ok-button");

    okButton.addEventListener('click', () => {
        submissionModal.style.display = 'none';
        document.body.classList.remove('modal-open');
        
        if (applicationsRemaining > 0) {
            applicationsRemaining--;
            countdownDisplay.textContent = applicationsRemaining;
            countdownValueDisplay.textContent = applicationsRemaining;
            triggerCelebration(applicationsRemaining);
        } else {
            triggerCelebration(0);
        }
    });

    const celebrationDiv = document.getElementById("celebration");
    const celebrationEmojis = document.getElementById("celebrationEmojis");
    const bellSound = document.getElementById("bellSound");
    let confettiInterval;
    let emojiInterval;

    const regularEmojis = ['🔔', '💪', '👍', '💰', '💯'];
    const finalEmojis = ['👏', '💰', '🔥', '🥂', '🎯'];

    function playBell() {
      bellSound.play().catch(err => {
        console.error("Bell sound blocked until user interacts:", err);
      });
    }

    function startConfetti() {
        const duration = 7 * 1000;
        const animationEnd = Date.now() + duration;
        const defaults = { startVelocity: 30, spread: 360, ticks: 60, zIndex: 9999 };
        const randomInRange = (min, max) => Math.random() * (max - min) + min;

        confettiInterval = setInterval(() => {
            const timeLeft = animationEnd - Date.now();
            if(timeLeft <= 0) {
                return clearInterval(confettiInterval);
            }
            const particleCount = 50 * (timeLeft / duration);
            confetti(Object.assign({}, defaults, { particleCount, origin: { x: randomInRange(0.1, 0.3), y: Math.random() - 0.2 } }));
            confetti(Object.assign({}, defaults, { particleCount, origin: { x: randomInRange(0.7, 0.9), y: Math.random() - 0.2 } }));
        }, 250);
    }

    function stopConfetti() {
        if (confettiInterval) {
            clearInterval(confettiInterval);
            confettiInterval = null;
        }
    }

    function startEmojiSlideshow(emojis) {
        let emojiIndex = 0;
        celebrationEmojis.innerHTML = '';
        emojiInterval = setInterval(() => {
            celebrationEmojis.innerHTML = `<span class="emoji-animated">${emojis[emojiIndex]}</span>`;
            emojiIndex = (emojiIndex + 1) % emojis.length;
        }, 1000);
    }

    function stopEmojiSlideshow() {
        if (emojiInterval) clearInterval(emojiInterval);
        celebrationEmojis.innerHTML = '';
    }

    function stopCelebration() {
        celebrationDiv.style.display = 'none';
        stopConfetti();
        stopEmojiSlideshow();
        bellSound.pause();
        bellSound.currentTime = 0;
    }

    function triggerCelebration(count) {
        celebrationDiv.style.display = 'flex';
        playBell();
        
        if (count > 0) {
            startEmojiSlideshow(regularEmojis);
        } else {
            startEmojiSlideshow(finalEmojis);
        }

        startConfetti();
    }

    document.getElementById('openSheetBtn').addEventListener('click', function() {
        window.open('https://docs.google.com/spreadsheets/d/1mXmwoF2qeJVoCsvK6GjsgV6xsc2x_RhGMs7vLAm1U4I/edit?gid=0#gid=0', '_blank');
    });

    function calculateROI() {
        const monthlyLeads = parseInt(document.getElementById('monthlyLeads').value) || 0;
        const conversionRate = parseInt(document.getElementById('conversionRate').value) || 0;
        const averageSale = parseInt(document.getElementById('averageSale').value) || 0;
        const expectedIncrease = parseInt(document.getElementById('expectedIncrease').value) || 0;
        const serviceCost = parseInt(document.getElementById('serviceCost').value) || 0;
        
        const currentConversions = monthlyLeads * (conversionRate / 100);
        const currentRevenue = currentConversions * averageSale;
        
        const projectedLeads = monthlyLeads * (1 + expectedIncrease / 100);
        const projectedConversions = projectedLeads * (conversionRate / 100);
        const projectedRevenue = projectedConversions * averageSale;
        
        const revenueIncrease = projectedRevenue - currentRevenue;
        const monthlyProfit = revenueIncrease - serviceCost;
        const roiPercentage = serviceCost > 0 ? (monthlyProfit / serviceCost) * 100 : 0;
        
        document.getElementById('currentRevenue').textContent = `${currentRevenue.toLocaleString()}`;
        document.getElementById('projectedRevenue').textContent = `${projectedRevenue.toLocaleString()}`;
        document.getElementById('revenueIncrease').textContent = `${revenueIncrease.toLocaleString()}`;
        document.getElementById('monthlyProfit').textContent = `${monthlyProfit.toLocaleString()}`;
        document.getElementById('roiPercentage').textContent = `${roiPercentage.toFixed(1)}% ROI`;
        
        document.getElementById('roiResults').style.display = 'block';
    }

    function showROICalculator() {
        document.getElementById('roiContainer').style.display = 'block';
        document.getElementById('crmDashboard').style.display = 'none';
        document.getElementById('telemarketingSection').style.display = 'none';
    }

    function showCRMDashboard() {
        document.getElementById('roiContainer').style.display = 'none';
        document.getElementById('crmDashboard').style.display = 'block';
        document.getElementById('telemarketingSection').style.display = 'none';
    }

    function showTelemarketingForm() {
        document.getElementById('roiContainer').style.display = 'none';
        document.getElementById('crmDashboard').style.display = 'none';
        document.getElementById('telemarketingSection').style.display = 'block';
    }

    function openTelemarketingForm() {
        window.open('https://taniad2169.github.io/Telemarketing/', '_blank');
    }

    function showAnalysisResult() {
        window.open('https://taniad2169.github.io/WS-Analysis-Result/', '_blank');
    }

    const frontOffice = document.getElementById('frontOffice');
    const backOffice = document.getElementById('backOffice');
    const backToFrontBtn = document.getElementById('backToFrontBtn');
    const taskDetail = document.getElementById('taskDetail');
    const taskType = document.getElementById('taskType');
    const otherTaskContainer = document.getElementById('otherTaskContainer');
    const addNewTaskBtn = document.getElementById('addNewTaskBtn');
    const leadsList = document.getElementById('leadsList');

    taskType.addEventListener('change', function() {
        if (this.value === 'other') {
            otherTaskContainer.style.display = 'block';
        } else {
            otherTaskContainer.style.display = 'none';
        }
    });

    backToFrontBtn.addEventListener('click', function() {
        backOffice.style.display = 'none';
        frontOffice.style.display = 'block';
        taskDetail.style.display = 'none';
    });

    document.getElementById('toggleViewBtn').addEventListener('click', function() {
        loginModal.style.display = 'block';
        document.body.classList.add('modal-open');
    });
    
    document.getElementById('searchLeadInput').addEventListener('input', function() {
        const searchTerm = this.value.toLowerCase().trim();
        const searchResults = document.getElementById('searchResults');
        
        if (searchTerm === '') {
            searchResults.innerHTML = '';
            return;
        }
        
        searchLeadsByIndustry(searchTerm);
    });
    
    async function searchLeadsByIndustry(searchTerm) {
        const searchResults = document.getElementById('searchResults');
        searchResults.innerHTML = '<div style="padding: 20px; text-align: center;">Searching...</div>';
        
        try {
            const querySnapshot = await window.getDocsFunction(window.collectionFunction(window.db, "leads"));
            const matchedLeads = [];
            
            querySnapshot.forEach((docSnap) => {
                const leadData = { id: docSnap.id, ...docSnap.data() };
                const industry = (leadData.industry || '').toLowerCase();
                const otherIndustry = (leadData.otherIndustry || '').toLowerCase();
                
                if (industry.includes(searchTerm) || otherIndustry.includes(searchTerm)) {
                    matchedLeads.push(leadData);
                }
            });
            
            if (matchedLeads.length === 0) {
                searchResults.innerHTML = '<div class="no-results">No leads found for "' + searchTerm + '"</div>';
            } else {
                let resultsHTML = '';
                matchedLeads.forEach(lead => {
                    const displayIndustry = lead.industry === 'Other' ? lead.otherIndustry : lead.industry;
                    resultsHTML += `
                        <div class="search-result-item" onclick="openLeadFromSearch('${lead.id}', ${JSON.stringify(lead).replace(/"/g, '&quot;')})">
                            <div class="search-result-name">${lead.name}</div>
                            <div class="search-result-details">
                                ${lead.company || 'No company'} | ${displayIndustry} | ${lead.phone || 'No phone'}
                            </div>
                        </div>
                    `;
                });
                searchResults.innerHTML = resultsHTML;
            }
        } catch (error) {
            searchResults.innerHTML = '<div style="padding: 20px; text-align: center; color: red;">Error: ' + error.message + '</div>';
        }
    }
    
    function openLeadFromSearch(id, leadData) {
        currentLeadId = id;
        openLead(leadData);
    }
    
    window.openLeadFromSearch = openLeadFromSearch;
    
    addNewTaskBtn.addEventListener('click', function() {
        taskDetail.style.display = 'block';
        isEditingTask = false;
        document.getElementById('taskType').value = 'call client';
        document.getElementById('taskDescription').value = '';
        document.getElementById('taskDueDate').value = '';
    });

    function openLead(leadData) {
        document.getElementById('leadModal').style.display = 'block';
        document.getElementById('overlay').classList.add('active');
        document.body.classList.add('modal-open');

        currentLeadData = leadData;
        
        document.getElementById('leadNameDisplay').textContent = leadData.name || '';
        document.getElementById('leadCompanyDisplay').textContent = leadData.company || '';
        document.getElementById('leadEmailDisplay').textContent = leadData.email || '';
        document.getElementById('leadPhoneDisplay').textContent = leadData.phone || '';
        document.getElementById('leadCityDisplay').textContent = leadData.city || '';
        document.getElementById('leadStateDisplay').textContent = leadData.state || '';
        document.getElementById('leadWebsiteDisplay').textContent = leadData.website || '';
        document.getElementById('leadHasWebsiteDisplay').textContent = leadData.hasWebsite || '';
        document.getElementById('leadIndustryDisplay').textContent = leadData.industry || '';
        document.getElementById('leadOtherIndustryDisplay').textContent = leadData.otherIndustry || '';
        document.getElementById('leadHowLongDisplay').textContent = leadData.howlonginbusiness || '';
        document.getElementById('leadBusinessTypeDisplay').textContent = leadData.typeofbusiness || '';
        document.getElementById('leadServiceDisplay').textContent = leadData.serviceinterestedin || '';
        document.getElementById('leadBestTimeDisplay').textContent = leadData.besttime || '';
        document.getElementById('leadContactWayDisplay').textContent = leadData.contactway || '';
        document.getElementById('leadNotesDisplay').textContent = leadData.notes || '';
    }

    function closeModals() {
        document.getElementById('leadModal').style.display = 'none';
        document.getElementById('moveModal').style.display = 'none';
        document.getElementById('overlay').classList.remove('active');
        document.body.classList.remove('modal-open');
    }

    function formatText(command) {
        document.execCommand(command);
    }
    
    function highlightText() {
        document.execCommand('backColor', false, 'yellow');
    }
    
    function removeHighlight() {
        document.execCommand('removeFormat');
    }
    
    function changeColor() {
        const color = document.getElementById('colorPicker').value;
        document.execCommand('foreColor', false, color);
    }
    
    function limitWords(el, maxWords) {
        const words = el.innerText.trim().split(/\s+/);
        if (words.length > maxWords) {
            el.innerText = words.slice(0, maxWords).join(" ");
            alert("Max 350 words allowed.");
        }
    }
    
    function showMoveModal() {
        document.getElementById('moveModal').style.display = 'block';
        document.getElementById('overlay').classList.add('active');
        document.body.classList.add('modal-open');
    }
    
    function editLead() {
        const nameDisplay = document.getElementById('leadNameDisplay');
        nameDisplay.contentEditable = true;
        nameDisplay.style.border = "1px solid #ccc";
        nameDisplay.style.padding = "5px";
        nameDisplay.style.borderRadius = "4px";
        
        document.getElementById('leadCompanyDisplay').contentEditable = true;
        document.getElementById('leadCompanyDisplay').style.border = "1px solid #ccc";
        document.getElementById('leadCompanyDisplay').style.padding = "5px";
        document.getElementById('leadCompanyDisplay').style.borderRadius = "4px";
        
        document.getElementById('leadEmailDisplay').contentEditable = true;
        document.getElementById('leadEmailDisplay').style.border = "1px solid #ccc";
        document.getElementById('leadEmailDisplay').style.padding = "5px";
        document.getElementById('leadEmailDisplay').style.borderRadius = "4px";
        
        document.getElementById('leadPhoneDisplay').contentEditable = true;
        document.getElementById('leadPhoneDisplay').style.border = "1px solid #ccc";
        document.getElementById('leadPhoneDisplay').style.padding = "5px";
        document.getElementById('leadPhoneDisplay').style.borderRadius = "4px";
        
        document.getElementById('leadNotesDisplay').contentEditable = true;
        document.getElementById('leadNotesDisplay').style.border = "1px solid #ccc";
        document.getElementById('leadNotesDisplay').style.padding = "5px";
        document.getElementById('leadNotesDisplay').style.borderRadius = "4px";
        
        const editBtn = document.getElementById('editLeadBtn');
        editBtn.textContent = "Save";
        editBtn.removeEventListener('click', editLead);
        editBtn.addEventListener('click', saveLeadEdits);
    }
    
    function saveLeadEdits() {
        const updatedName = document.getElementById('leadNameDisplay').textContent;
        const updatedCompany = document.getElementById('leadCompanyDisplay').textContent;
        const updatedEmail = document.getElementById('leadEmailDisplay').textContent;
        const updatedPhone = document.getElementById('leadPhoneDisplay').textContent;
        const updatedNotes = document.getElementById('leadNotesDisplay').textContent;
        
        currentLeadData.name = updatedName;
        currentLeadData.company = updatedCompany;
        currentLeadData.email = updatedEmail;
        currentLeadData.phone = updatedPhone;
        currentLeadData.notes = updatedNotes;
        
        saveLeadEditsToFirebase(currentLeadData);
        
        document.getElementById('leadNameDisplay').contentEditable = false;
        document.getElementById('leadNameDisplay').style.border = "none";
        document.getElementById('leadNameDisplay').style.padding = "0";
        
        document.getElementById('leadCompanyDisplay').contentEditable = false;
        document.getElementById('leadCompanyDisplay').style.border = "none";
        document.getElementById('leadCompanyDisplay').style.padding = "0";
        
        document.getElementById('leadEmailDisplay').contentEditable = false;
        document.getElementById('leadEmailDisplay').style.border = "none";
        document.getElementById('leadEmailDisplay').style.padding = "0";
        
        document.getElementById('leadPhoneDisplay').contentEditable = false;
        document.getElementById('leadPhoneDisplay').style.border = "none";
        document.getElementById('leadPhoneDisplay').style.padding = "0";
        
        document.getElementById('leadNotesDisplay').contentEditable = false;
        document.getElementById('leadNotesDisplay').style.border = "none";
        document.getElementById('leadNotesDisplay').style.padding = "0";
        
        const saveBtn = document.getElementById('editLeadBtn');
        saveBtn.textContent = "Edit";
        saveBtn.removeEventListener('click', saveLeadEdits);
        saveBtn.addEventListener('click', editLead);
    }
    
    function deleteLead() {
        if (confirm("Are you sure you want to delete this lead?")) {
            deleteLeadFromFirebase(currentLeadId);
            closeModals();
        }
    }

    function completeTask() {
        alert("Task marked as complete!");
        document.getElementById('taskDetail').style.display = 'none';
    }

    function editTask() {
        alert("Edit task functionality would go here!");
    }

    function deleteTask() {
        if (confirm("Are you sure you want to delete this task?")) {
            alert("Task deleted!");
            document.getElementById('taskDetail').style.display = 'none';
        }
    }

    function cancelTask() {
        document.getElementById('taskDetail').style.display = 'none';
    }

    function saveTask() {
        alert("Task saved!");
        document.getElementById('taskDetail').style.display = 'none';
    }

</script>
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, doc, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyD6VqxUGb5Q2kAVDHQjYkFsp9GHNymBMfg",
      authDomain: "crmleads-3f1a7.firebaseapp.com",
      projectId: "crmleads-3f1a7",
      storageBucket: "crmleads-3f1a7.firebasestorage.app",
      messagingSenderId: "317614128849",
      appId: "1:317614128849:web:86be5c842c0f0e84768ff0"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    
    window.db = db;
    window.doc = doc;
    window.deleteDoc = deleteDoc;
    window.updateDoc = updateDoc;
    window.collectionFunction = collection;
    window.getDocsFunction = getDocs;

    async function loadLeads() {
        const leadsList = document.getElementById('leadsList');
        if (!leadsList) {
            return;
        }
        
        leadsList.innerHTML = '<div style="padding: 20px; text-align: center;">Loading leads...</div>';
        
        const leadFilter = document.getElementById('leadFilter').value;
        
        try {
            const querySnapshot = await getDocs(collection(db, "leads"));
            
            const leads = [];
            querySnapshot.forEach((docSnap) => {
                const leadData = { id: docSnap.id, ...docSnap.data() };
                
                if (!leadData.status) {
                    leadData.status = "all";
                }
                
                if (leadFilter === 'all' || leadData.status === leadFilter) {
                    leads.push(leadData);
                }
            });
            
            if (leads.length === 0) {
                leadsList.innerHTML = '<div style="padding: 20px; text-align: center; color: #666;">No leads found. Submit a form to create your first lead!</div>';
            } else {
                displayLeads(leads);
            }
        } catch (error) {
            leadsList.innerHTML = '<div style="padding: 20px; text-align: center; color: red;">Error loading leads: ' + error.message + '</div>';
        }
    }
    
    window.loadLeadsFunction = loadLeads;

    function displayLeads(leads) {
        const leadsList = document.getElementById('leadsList');
        if (!leadsList) return;
        leadsList.innerHTML = '';
        leads.forEach(lead => {
            const leadItem = document.createElement('div');
            leadItem.classList.add('lead-item');
            leadItem.dataset.id = lead.id;
            leadItem.dataset.lead = JSON.stringify(lead);
            
            let statusDisplay = 'All Leads';
            if (lead.status === 'new') statusDisplay = 'New Leads';
            else if (lead.status === 'hot') statusDisplay = 'Hot Leads';
            else if (lead.status === 'interested') statusDisplay = 'Interested';
            else if (lead.status === 'demo') statusDisplay = 'Free Demo Scheduled';
            else if (lead.status === 'client') statusDisplay = 'Client';
            else if (lead.status === 'cancelled') statusDisplay = 'Cancelled';
            else if (lead.status === 'referral') statusDisplay = 'Referral Leads';
            else if (lead.status === 'website_analysis') statusDisplay = 'Website Analysis';
            else if (lead.status === 'website_demo') statusDisplay = 'Website Demo';
            else if (lead.status === 'call_backs') statusDisplay = 'Call Backs';
            else if (lead.status === 'send_email') statusDisplay = 'Send Email';
            
            leadItem.innerHTML = `
                <div class="font-bold">${lead.name}</div>
                <div class="text-sm text-gray-600">${lead.company} - ${statusDisplay}</div>
            `;
            leadsList.appendChild(leadItem);
        });

        leadsList.addEventListener('click', function(e) {
            const leadItem = e.target.closest('.lead-item');
            if (leadItem) {
                const leadData = JSON.parse(leadItem.dataset.lead);
                currentLeadId = leadItem.dataset.id;
                openLead(leadData);
            }
        });
    }

    async function saveLeadEditsToFirebase(leadData) {
        try {
            const leadRef = doc(db, "leads", currentLeadId);
            await updateDoc(leadRef, {
                name: leadData.name,
                company: leadData.company,
                email: leadData.email,
                phone: leadData.phone,
                notes: leadData.notes,
                updatedAt: new Date()
            });
            alert("Lead details saved successfully!");
            loadLeads();
        } catch (error) {
            alert("Error saving lead: " + error.message);
        }
    }

    async function deleteLeadFromFirebase(leadId) {
        try {
            const leadRef = doc(db, "leads", leadId);
            await deleteDoc(leadRef);
            alert("Lead deleted successfully!");
            loadLeads();
        } catch (error) {
            alert("Error deleting lead: " + error.message);
        }
    }

    async function moveLead(category) {
        try {
            const leadRef = doc(db, "leads", currentLeadId);
            await updateDoc(leadRef, {
                status: category
            });
            alert("Lead moved successfully!");
            loadLeads();
            closeModals();
        } catch (error) {
            alert("Error moving lead: " + error.message);
        }
    }

    async function saveLead(data) {
      try {
        const leadData = {
          ...data,
          status: "all",
          createdAt: new Date()
        };
        
        await addDoc(collection(db, "leads"), leadData);
        
        const submissionModal = document.getElementById('submissionModal');
        submissionModal.style.display = "flex";
        document.body.classList.add('modal-open');
        loadLeads();
      } catch (error) {
        alert("Error saving lead: " + error.message);
      }
    }
    
    async function saveTaskFirebase(task) {
      try {
        await addDoc(collection(db, "tasks"), {
            ...task,
            createdAt: new Date(),
            status: 'pending'
        });
        alert("Task saved successfully in Firebase!");
      } catch (error) {
            alert("Error saving task: " + error.message);
      }
    }

    document.getElementById('leadForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      const formData = new FormData(this);
      let data = {};
      for (let [key, value] of formData.entries()) {
          data[key] = value;
      }
      
      await saveLead(data);
      this.reset();
    });

    document.getElementById('taskDetail').querySelector('.btn-save').addEventListener('click', async function() {
        const taskType = document.getElementById('taskType').value;
        const otherTask = document.getElementById('otherTask').value;
        const taskDescription = document.getElementById('taskDescription').value;
        const taskDueDate = document.getElementById('taskDueDate').value;

        const taskData = {
            type: taskType,
            description: taskDescription,
            dueDate: taskDueDate,
            otherTask: otherTask
        };
        await saveTaskFirebase(taskData);
        document.getElementById('taskDetail').style.display = 'none';
    });
    
    document.getElementById('leadFilter').addEventListener('change', loadLeads);

    const observer = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
            if (mutation.target.id === 'backOffice' && mutation.target.style.display === 'block') {
                loadLeads();
            }
        });
    });
    
    const backOfficeElement = document.getElementById('backOffice');
    observer.observe(backOfficeElement, { attributes: true, attributeFilter: ['style'] });
    
    window.addEventListener("load", loadLeads);
    
    window.moveLead = moveLead;
    window.deleteLeadFromFirebase = deleteLeadFromFirebase;
    window.openLead = openLead;
    window.saveLeadEditsToFirebase = saveLeadEditsToFirebase;
</script>
</body>
</html>
